### 1. 数据清洗与格式化的课程概述
本课程提供了关于数据清洗与格式化的系统化知识，重点是帮助研究生掌握从原始数据到分析准备数据的完整处理过程。通过该课程的学习，研究生可以理解数据清洗和格式化的核心步骤、应用场景、常见问题和解决方法。课程的内容适用于各种数据类型，包括数值、日期、类别、文本数据，以及空间数据和网络数据等更复杂的特殊数据。

#### 数据清洗与格式化的步骤
1. **数据清洗**：清除数据中的错误、缺失值、冗余信息，并确保数据完整性和准确性。
2. **数据格式化**：根据分析需求调整数据格式和类型，以便分析工具（如统计软件或编程语言）能够正确处理。

#### 学习目标
- 掌握数值、日期、类别和文本数据的清洗与格式化方法。
- 理解并应用数据类型转换技术，确保数据能够被正确读取和处理。
- 了解空间数据与网络数据的特殊处理需求。
- 为数据分析和模型构建准备高质量的数据。

---

### 2. 数据清洗与格式化的区别
- **数据清洗**：数据清洗的目标是确保数据的完整性和一致性。清洗包括删除重复数据、处理缺失值、去除异常值、规范数据格式等操作，使数据在结构上更为合理。
  - **典型操作**：去除空格、修正错误值、替换缺失值、删除重复行。
  - **工具**：`pandas` 中的 `.dropna()`、`.fillna()`、`.replace()` 等方法。
- **数据格式化**：格式化是将数据类型或结构调整到符合分析需求的标准。格式化确保数据被正确识别（例如，将日期列识别为日期格式）。
  - **典型操作**：数值转换、日期转换、文本标准化、类别转换。
  - **工具**：`pandas` 的 `.astype()`、`.to_datetime()`、`Categorical` 类型等。

---

### 3. 数值数据的格式化
数值数据格式化是指将数值数据从文本或其他非数值格式转换为数值类型，如整数（`int`）或浮点数（`float`）。这种转换确保数据可以被用于数值计算和分析。

#### 3.1 数值类型转换的必要性
在数据收集过程中，数值数据有时会被误识别为字符串。常见原因包括数据中的符号（如 `$`、`%`），或意外的空格和标点。这种误识别会导致数据不能进行数值计算。因此，需将这些列强制转换为数值类型。

#### 3.2 常用转换方法
- **R 中的 `as.numeric()` 函数**：`as.numeric()` 将字符串转换为数值类型，遇到非数值字符时会生成 `NA`（缺失值），并提示警告。
- **Python 中的 `pd.to_numeric()` 函数**：通过设置 `errors` 参数，控制非数值字符的处理方式：
  - `errors='raise'`：默认行为，遇到非数值字符会报错。
  - `errors='coerce'`：将非数值字符转换为 `NaN`，继续处理其他数值。
  - `errors='ignore'`：忽略非数值字符，不转换列类型。

#### 示例代码
```python
import pandas as pd

# 假设 `df` 数据框中的 'amount' 列为文本类型，需要转换为数值类型
df['amount'] = pd.to_numeric(df['amount'], errors='coerce')

# 检查转换结果，确保非数值字符被转换为 NaN
print(df['amount'].isna().sum())  # 输出 NaN 的数量
```

#### 3.3 异常值的清洗
数值转换过程中出现的 NaN 表示该数据存在异常字符（如 `$`、逗号、空格等），这些字符需要在数据清洗阶段去除或替换。以下是去除特殊字符的代码示例：

```python
# 去除 '$' 和 ',' 符号，再强制转换为数值类型
df['amount'] = df['amount'].replace('[\$,]', '', regex=True).astype(float)
```

---

### 4. 日期数据的格式化
日期数据在许多分析和建模中非常重要，但通常会以字符串形式存储（例如“2024-11-01”），因此需将其转换为日期格式，以便支持时间序列分析或日期操作。

#### 4.1 避免日期格式自动推断
在读取日期数据时，不推荐使用自动推断日期格式的方法（如 Pandas 中的 `infer_datetime_format=True`），因为推断可能因地区差异而出错。推荐在读取数据时手动指定日期格式，确保一致性。

#### 4.2 日期格式符号的说明
常见日期格式符号包括：
  - **年**：`%Y` 表示4位数年份，如 `2023`；`%y` 表示2位数年份，如 `23`。
  - **月**：`%m` 表示数字月份（如 `01-12`）；`%b` 表示月份缩写（如 `Jan`）；`%B` 表示完整月份名称（如 `January`）。
  - **日**：`%d` 表示日期数字（如 `01-31`）。

#### 示例代码
假设日期列的格式为 `日/月/年`：
```python
# 使用 Pandas 将字符串日期转换为日期格式
df['date_column'] = pd.to_datetime(df['date_column'], format='%d/%m/%Y')

# 检查转换结果，确保为日期类型
print(df['date_column'].dtypes)  # 应显示 datetime64 类型
```

---

### 5. 类别数据的格式化
类别数据包含有限的唯一值（如性别、等级），可分为名义数据和有序数据。将数据转换为类别类型能有效节省内存，并且在分析中提升效率。

#### 5.1 名义数据
名义数据是无序的类别数据，例如性别（Male/Female）或国家（USA/Canada）。

##### 示例代码
```python
# 将性别数据转换为类别类型
df['gender'] = df['gender'].astype('category')

# 检查转换结果
print(df['gender'].dtypes)  # 应显示 category 类型
```

#### 5.2 有序数据
有序数据具有顺序关系，例如教育程度（小学、初中、高中）或满意度（1-非常不满意到5-非常满意）。为了保持顺序关系，可使用 `pd.Categorical` 进行转换。

##### 示例代码
```python
# 定义映射字典，将满意度字符串转换为有序数值
satisfaction_mapping = {'非常不满意': 1, '不满意': 2, '一般': 3, '满意': 4, '非常满意': 5}
df['satisfaction'] = df['satisfaction'].map(satisfaction_mapping)

# 转换为有序类别类型
df['satisfaction'] = pd.Categorical(df['satisfaction'], ordered=True)
```

---

### 6. 文本数据的处理
文本数据处理是为了确保数据一致性，避免合并或分组操作时因格式差异产生的错误。

#### 6.1 文本标准化
文本标准化主要包括大小写转换和去除多余空格。建议统一文本数据格式，以确保数据一致性，尤其在后续合并时十分重要。

##### 示例代码
```python
# 将国家名称全部转换为大写，去除多余空格
df['country'] = df['country'].str.strip().str.upper()
```

#### 6.2 文本归一化
文本归一化常用于自然语言处理（NLP），例如将 `working`、`worked`、`works` 归一为 `work`，以便后续分析中的一致性。

##### 示例代码
使用 `nltk` 库进行词干提取：
```python
from nltk.stem import PorterStemmer
ps = PorterStemmer()

# 词干提取，将动词统一为词根形式
df['text_column'] = df['text_column'].apply(lambda x: ' '.join(ps.stem(word) for word in x.split()))
```

---

### 7. 空间数据与网络数据的格式化

#### 7.1 空间数据的格式化
空间数据包括几何信息（如经纬度），在地理分析中应用广泛。确保数据包含正确的坐标系（CRS）和投影信息是空间数据格式化的重点。

##### 示例代码
```python
import geopandas as gpd

# 读取 Shapefile 数据
gdf = gpd.read_file('map_data.shp')

# 检查坐标系
print(gdf.crs)

# 若需要转换为 WGS84 坐标系
gdf = gdf.to_crs(epsg=432

6)
```

#### 7.2 网络数据的格式化
网络数据主要用于构建图结构（Graph），一般有两种存储形式：邻接矩阵和边列表。

##### 示例代码
假设有一边列表数据，将其转换为图对象：
```python
import networkx as nx

# 使用 Pandas 读取边列表
edge_list = pd.DataFrame({'node1': [1, 2, 3], 'node2': [2, 3, 4]})
G = nx.from_pandas_edgelist(edge_list, source='node1', target='node2')

# 查看图的基本信息
print(nx.info(G))
```

---

### 8. 总结与建议
- **数据一致性与标准化**：保持数据类型和格式的一致性，避免因格式差异而导致的合并、分组或分析错误。
- **中间结果的备份**：在完成数据清洗和格式化后，保存数据的中间结果，以便在必要时重新验证和追溯。
- **格式化的目标**：数据格式化是为后续分析提供一致的、高质量的输入数据，确保数据能被正确理解和处理，提高分析精度。