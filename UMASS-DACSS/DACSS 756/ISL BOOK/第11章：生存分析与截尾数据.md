# 第11章：生存分析与截尾数据

## 11.1 基本概念

### 11.1.1 生存时间与截尾
生存时间观测值定义为：

$$Y_i = \min(T_i, C_i)$$

状态指标：

$$\delta_i = \begin{cases}
1 & \text{若事件发生 }(T_i \leq C_i) \\
0 & \text{若截尾 }(T_i > C_i)
\end{cases}$$

### 11.1.2 生存函数与危险函数
生存函数：

$$S(t) = P(T > t)$$

危险函数：

$$h(t) = \lim_{\Delta t \to 0} \frac{P(t < T \leq t + \Delta t | T > t)}{\Delta t}$$

两者关系：

$$S(t) = \exp\left(-\int_0^t h(u)du\right)$$

## 11.2 Kaplan-Meier估计

### 11.2.1 估计公式
在时间点 $t_k$ 的生存概率估计：

$$\hat{S}(t_k) = \hat{S}(t_{k-1})\left(1 - \frac{d_k}{n_k}\right)$$

其中：
- $d_k$ 是时间 $t_k$ 发生事件的数量
- $n_k$ 是风险集大小

## 11.3 对数秩检验

### 11.3.1 检验统计量
对数秩统计量：

$$W = \frac{\sum_{j=1}^J(O_j - E_j)}{\sqrt{\sum_{j=1}^J V_j}}$$

其中：
- $O_j$ 是观察值
- $E_j$ 是期望值
- $V_j$ 是方差

## 11.4 Cox比例风险模型

### 11.4.1 模型定义
危险函数：

$$h(t|X) = h_0(t)\exp(\beta^T X)$$

其中：
- $h_0(t)$ 是基线危险函数
- $\beta$ 是回归系数
- $X$ 是协变量向量

### 11.4.2 偏似然函数

$$L(\beta) = \prod_{i:\delta_i=1} \frac{\exp(\beta^T X_i)}{\sum_{j\in R(t_i)}\exp(\beta^T X_j)}$$

其中 $R(t_i)$ 是时间 $t_i$ 的风险集

## 11.5 模型诊断

### 11.5.1 比例风险假设检验
Schoenfeld残差：

$$r_{ij} = X_{ij} - \frac{\sum_{k\in R(t_i)}X_{kj}\exp(\beta^T X_k)}{\sum_{k\in R(t_i)}\exp(\beta^T X_k)}$$

### 11.5.2 模型适应度

$$AIC = -2\log L(\hat{\beta}) + 2p$$

其中 $p$ 是模型参数数量

## 11.6 时变协变量

### 11.6.1 扩展Cox模型

$$h(t|X(t)) = h_0(t)\exp(\beta^T X(t))$$

其中 $X(t)$ 是时变协变量

### 11.6.2 计算复杂度
对数偏似然：

$$\ell(\beta) = \sum_{i:\delta_i=1}\left[\beta^T X_i(t_i) - \log\sum_{j\in R(t_i)}\exp(\beta^T X_j(t_i))\right]$$

## 11.7 竞争风险模型

### 11.7.1 累积发生函数
第 $k$ 类事件的累积发生函数：

$$F_k(t) = P(T \leq t, D = k) = \int_0^t h_k(u)S(u)du$$

其中 $D$ 是事件类型

### 11.7.2 子分布危险函数

$$\lambda_k(t) = \lim_{\Delta t \to 0}\frac{P(t \leq T < t + \Delta t, D = k|T \geq t \text{ or } (T \leq t \text{ and } D \neq k))}{\Delta t}$$

## 11.8 预测与评估

### 11.8.1 C指数

$$C = \frac{\sum_{i<j}I(T_i < T_j)I(\hat{\eta}_i > \hat{\eta}_j)\delta_i}{\sum_{i<j}I(T_i < T_j)\delta_i}$$

其中 $\hat{\eta}_i$ 是预测风险

### 11.8.2 Brier分数
在时间 $t$ 的Brier分数：

$$BS(t) = \frac{1}{n}\sum_{i=1}^n[\hat{S}(t|X_i)^2I(T_i \leq t, \delta_i=1) + (1-\hat{S}(t|X_i))^2I(T_i > t)]$$

## 11.9 实践考虑

### 11.9.1 样本量计算
需要的事件数：

$$d = \frac{4(z_{\alpha/2} + z_\beta)^2}{\log^2(HR)}$$

其中：
- $HR$ 是预期风险比
- $\alpha$ 是显著性水平
- $\beta$ 是检验效能

### 11.9.2 缺失数据处理
多重插补方法：
1. 生成多个完整数据集
2. 分别分析
3. 合并结果

## 11.10 总结

### 优势
1. 处理截尾数据
2. 考虑时间依赖性
3. 非参数和半参数方法

### 局限性
1. 比例风险假设
2. 缺失数据影响
3. 竞争风险复杂性

### 应用场景
1. 医学研究
2. 可靠性分析
3. 客户流失研究
4. 设备寿命预测