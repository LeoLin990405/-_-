### Week 7 讲义笔记：广义线性模型（GLM）的诊断分析

本次讲义聚焦于广义线性模型（GLMs）的诊断分析，重点在于残差（Residuals）的类型及其特性、杠杆值（Leverage）和标准化残差、模型的影响力（Influence），并介绍了R中的相关诊断图工具。以下为详细的知识点整理：

---

#### 1. 残差的定义与类型

广义线性模型的残差不如线性模型那样易于解释，因为 GLM 中没有简单的结构部分和误差项分离。残差用于评估观测值和拟合值的差异，而 GLM 中常用的四种残差定义如下：

##### 1.1 响应残差 (Response Residuals)

- **定义**：响应残差是观测值 $y_i$ 与拟合值 $\hat{\mu}_i$ 之差：
  $$ r_i^{(r)} = y_i - \hat{\mu}_i $$
- **解释**：响应残差的计算类似于普通线性模型的残差，仅仅表示了观测值与拟合值之间的直接差异，未考虑方差的不同。其意义在于直接反映观测值和预测值的简单差异。

##### 1.2 Pearson 残差 (Pearson Residuals)

- **定义**：Pearson 残差通过调整方差函数 $V(\mu_i)$ 和先验权重 $w_i$ 的影响，使得残差更加规范化：
  $$ r_i^{(p)} = \frac{y_i - \hat{\mu}_i}{\sqrt{V(\hat{\mu}_i)/w_i}} $$
- **性质**：
  - 当样本量趋向无穷大（$n \to \infty$）时，Pearson 残差的期望值为 0，即 $E(r_i^{(p)}) \to 0$。
  - Pearson 残差的方差趋向于 $\phi(1 - h_i)$，其中 $h_i$ 为第 $i$ 个观测的杠杆值。
- **用途**：适合用于模型的诊断，因为它标准化了观测值与拟合值之间的差异，使得残差对不同方差具有可比性。

##### 1.3 偏差残差 (Deviance Residuals)

- **定义**：偏差残差基于单位偏差函数 $d(y, \mu)$ 定义，并考虑了观测值相对于拟合值的符号：
  $$ r_i^{(d)} = \text{sign}(y_i - \hat{\mu}_i) \sqrt{w_i d(y_i, \hat{\mu}_i)} $$
  其中 $\text{sign}(y_i - \hat{\mu}_i)$ 取决于差值的符号。
- **性质**：
  - 偏差的总和可以表示为偏差残差的平方和，即 $D(y, \hat{\mu}) = \sum_{i=1}^n w_i d(y_i, \hat{\mu}_i) = \sum_{i=1}^n \left[r_i^{(d)}\right]^2$。
  - 偏差残差的期望值不一定为零，因而其在诊断图中的应用有限。
- **用途**：在正态 QQ 图中用于检验模型假设，因为偏差残差适合于观察拟合效果和数据分布的偏离情况。

##### 1.4 工作残差 (Working Residuals)

- **定义**：工作残差基于迭代加权最小二乘 (IWLS) 算法的最后一轮迭代结果，可以表示为：
  $$ r_i^{(w)} = (y_i - \hat{\mu}_i)g'(\hat{\mu}_i) $$
  其中 $g'(\hat{\mu}_i)$ 为链接函数 $g(\mu)$ 对 $\mu$ 的导数。
- **性质**：工作残差并未考虑观测值之间的方差差异，因此需要使用工作权重 $W_i$ 来正确解释。
- **用途**：工作残差主要用于计算模型的其他指标，而非直接用于模型诊断。

##### 1.5 在 R 中的残差使用

R 中的 `residuals()` 函数可以提取上述不同类型的残差，通过 `type` 参数指定残差类型，例如 `type="response"`、`type="pearson"`、`type="deviance"` 和 `type="working"`。若不指定 `type` 参数，默认返回偏差残差。

---

#### 2. 杠杆值和标准化残差

在模型诊断中，杠杆值衡量的是某个观测对模型拟合值的影响力；标准化残差则通过标准化残差值，排除不同观测点的方差差异。

##### 2.1 杠杆值 (Leverage)

- **定义**：GLM 中，杠杆值 $h_i$ 是帽子矩阵的对角线元素 $H_{ii}$，其公式为：
  $$ H = X (X^T W X)^{-1} X^T W $$
  其中 $W = \text{diag}(w_1, \dots, w_n)$ 是对角权重矩阵。
- **性质**：
  - $h_i$ 取值范围为 $[0, 1]$，并衡量观测值 $y_i$ 对其拟合值 $\hat{\mu}_i$ 的影响力。
  - 当 $h_i = 1$ 时，观测值和拟合值相等，即 $\hat{\mu}_i = y_i$；此时残差为零，表示该观测对模型的强烈影响。
  - 杠杆值较高的观测往往在预测变量值上距离均值较远（连续变量）或属于稀有类别（分类变量）。

##### 2.2 标准化残差 (Standardized Residuals)

- **定义**：标准化残差是将残差除以其估计的标准差。对于标准化 Pearson 残差，可以表示为：
  $$ r_i^{(sp)} = \frac{\sqrt{w_i}(y_i - \hat{\mu}_i)}{\sqrt{(1 - h_i)\phi}} $$
  其中 $\phi$ 是离散参数的无偏估计量。
- **性质**：标准化残差的渐近方差为1（当 $n \to \infty$ 时）。
- **用途**：标准化残差用于识别异常值和诊断模型拟合情况，尤其适合用于 QQ 图中检验残差的正态性。

---

#### 3. 影响力分析（Influence）

影响力分析旨在评估单个观测对模型参数估计的影响程度。如果删除一个观测值会导致模型拟合或预测值的显著变化，则称该观测具有**影响力**。

##### 3.1 Cook 距离 (Cook’s Distance)

- **定义**：Cook 距离用于度量删除某个观测对模型拟合值的影响。对于 GLM，Cook 距离计算公式为：
  $$ D_i^{\text{Cook}} = \frac{1}{p} \frac{[r_i^{(sp)}]^2 h_i}{1 - h_i} $$
  其中 $r_i^{(sp)}$ 是标准化 Pearson 残差，$p$ 为参数个数。
- **性质**：
  - 当 Cook 距离值较大时，表明该观测点对模型拟合有显著影响。
  - Cook 距离值通常没有严格的阈值，应结合分布情况，观察是否有明显大于其他观测值的点。
- **处理**：发现有显著影响的观测点时，通常不建议直接删除，而应进一步调查其原因，除非有充分的证据表明该点是不合理的。

---

#### 4. R 中的诊断图工具

R 中提供了一系列用于模型诊断的图形函数，帮助检查残差分布、异常值和高影响力观测点。

##### 4.1 残差与拟合值的散点图

- **功能**：观察 Pearson 残差与拟合值之间的关系，帮助识别模型结构问题。
- **图示**：在拟合值横轴上绘制 Pearson 残差，并拟合平滑曲线（红线）。若模型结构正确，平滑曲线应接近零水平线。

##### 4.2 QQ 图

- **功能**：用于检查标准化 Pearson 残差的分布是否接近正态。
- **图示**：纵轴为标准化残差的绝对值，横轴为标准半正态分布的分位数。若残差符合正态分布，点应接近对角线。