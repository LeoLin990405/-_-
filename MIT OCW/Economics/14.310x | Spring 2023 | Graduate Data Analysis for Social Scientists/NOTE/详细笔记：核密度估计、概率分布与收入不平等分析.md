# **详细笔记：核密度估计、概率分布与收入不平等分析**  
### 授课人：Esther Duflo  
---

## **1. 导论：课程内容和计划概述**  
本次课程主要讲解 **核密度估计（Kernel Density Estimation, KDE）** 及其在数据分析中的应用，重点探讨如何通过 KDE 更平滑地估计分布。Duflo 还对 **概率密度函数（PDF）** 和 **累积分布函数（CDF）** 的使用场景进行了比较，并通过 **收入不平等** 和 **高收入建模（Pareto 分布）** 的实际案例，展示了这些概念的应用。  

---

## **2. 从直方图到核密度估计（KDE）**  

### **2.1 直方图的原理与局限性**  
- **直方图（Histogram）** 是通过将数据划分为若干个区间（bin）并统计每个区间的频数，来展示数据分布的常用方法。  
- **主要局限性：**
  1. **区间数量（bin size）的选择敏感性：**  
     - **区间过少**：分布看起来简单化，容易产生误导，如出现虚假的偏斜。  
     - **区间过多**：分布过于波动，增加噪声，掩盖真实模式。  
  2. **不连续性：** 直方图是离散的，无法平滑地描述数据的整体分布。

- **改进需求：**  
  为了更准确描述数据的分布，我们希望有一种工具能在 **全区间上连续绘制**，而不仅依赖于预设区间。这就是 **核密度估计（KDE）** 的核心优势。

---

### **2.2 核密度估计（KDE）的数学原理与实现**  
#### **KDE 的基本定义**
- **核密度估计（KDE）** 是一种平滑曲线的方法，它通过每个观测点周围的核函数将数据分布扩展为 **连续曲线**。  
- **KDE 公式：**  
  对于样本 \( \{x_1, x_2, \dots, x_n\} \)，核密度估计在 \(x\) 处的值为：  
  $$
  \hat{f}(x) = \frac{1}{n h} \sum_{i=1}^{n} K\left(\frac{x - x_i}{h}\right)
  $$
  **解释：**
  - \(n\)：样本数量。  
  - \(K(\cdot)\)：**核函数**，描述数据点对某位置的影响。  
  - \(h\)：**带宽（Bandwidth）**，控制核函数的宽度。

#### **KDE 的直观解释**  
- KDE 的核心思想是：在每个观测点 \(x_i\) 处 **绘制一个核函数 K**，核函数的形状由用户选择。  
  - 每个核函数都为数据点分布赋予一定的“影响力”，离数据点越远，影响力越小。  
  - **带宽 \(h\)** 控制了核函数的“扩散范围”。  
    - 较小的 \(h\) 会使曲线更陡峭、更波动。
    - 较大的 \(h\) 会使曲线更平滑，但可能掩盖局部特征。

---

### **2.3 核函数的类型与特性**  
1. **Uniform Kernel（均匀核）：**  
   - 在核范围内权重相同，超出范围后权重为 0。  
   - **优点：** 计算简单。  
   - **缺点：** 分布不够平滑。

2. **Gaussian Kernel（高斯核）：**  
   - **钟形曲线**，权重随距离衰减，但永远不为 0。  
   - **优点：** 分布光滑。  
   - **缺点：** 计算复杂度高，因为核函数对所有点都有非零影响。

3. **Epanechnikov Kernel（埃潘尼切科夫核）：**  
   - 抛物线形的核函数，**在核范围内有界**。  
   - **优点：** 计算效率高，是统计中常用的核函数。

---

### **2.4 带宽（Bandwidth）的选择与偏差-方差权衡（Bias-Variance Tradeoff）**  
#### **带宽 \(h\) 的影响：**
- **小带宽（h 小）：**
  - 高方差（Variance）→ 曲线过于波动，容易过拟合。
  - 适合发现数据中的细微模式，但不适用于噪声较多的数据。

- **大带宽（h 大）：**
  - 高偏差（Bias）→ 曲线过于平滑，容易忽略数据的关键特征。
  - 适合处理噪声较大的数据，但可能错过局部特征。

#### **偏差-方差权衡：**
- **目标：** 最小化均方误差（Mean Squared Error, MSE）：  
  $$
  MSE = \text{Bias}^2 + \text{Variance}
  $$
- KDE 的核心问题是找到一个合适的带宽，使得模型既不过拟合，也不过度平滑。

#### **实际应用中的建议：**
- 一般可以使用 **软件默认带宽**（如 R 语言的 `density()` 函数），并在实际分析中 **调整带宽** 观察其对结果的影响。

---

## **3. PDF 和 CDF 的比较与应用场景**

### **3.1 概率密度函数（PDF）**
- **PDF（Probability Density Function）** 描述随机变量在不同值处的 **概率密度**。  
- **特点：**  
  - 曲线高度表示在某个点或区间内的“概率密度”。
  - **面积** 表示某区间内的总概率（概率总和为 1）。

- **用途：**
  - 适用于观察分布的 **模式、峰值（Mode）和偏斜情况**。
  - 直观展示数据是否呈现 **对称性** 或 **偏斜性**。

---

### **3.2 累积分布函数（CDF）**
- **CDF（Cumulative Distribution Function）** 描述随机变量小于某特定值的 **累计概率**。  
  - **特性：** CDF 为 **非递减函数**，从 0 上升到 1。  
  - **形式化定义：**  
    $$
    F(x) = P(X \leq x)
    $$
    表示随机变量 \(X\) 小于或等于 \(x\) 的概率。

- **用途：**  
  - **概率比较：** 判断一个分布是否在统计意义上优于另一个分布。
  - **一阶随机占优：** 若 A 的 CDF 始终在 B 的 CDF 之下，说明 A 的分布在统计上占优。

---

### **3.3 案例：身高数据的 PDF 和 CDF 比较**  
- **分析对象：** 比较 **美国女性** 和 **印度女性** 的身高分布。  
  - **PDF 分析：**
    - 美国女性的 **PDF 向右偏移**，表明平均身高较高。
  - **CDF 分析：**
    - **CDF 曲线：** 印度女性的 CDF 始终高于美国女性的 CDF。
    - **解释：** 这表明 **美国女性的身高分布在统计上优于印度女性**，即美国女性在每个高度上的比例较低。

---

## **4. 收入不平等分析与 Pareto 分布**  

### **4.1 收入数据的特点与挑战**  
- **数据来源：** 加州工资调查（2014 年 CPS 数据）。  
  - **原始数据：** 分布严重 **左偏**，表明存在大量低收入者和少量高收入者。
  - **对数变换后：** 数据更接近 **对数正态分布**。

- **最高收入封顶（Top-Coding）：**  
  - 在 CPS 数据中，为了 **保护隐私**，所有超过某一阈值的收入都被记录为相同值。这限制了我们对 **高收入群体** 的深入分析。

---

### **4.2 Pareto 分布在高收入建模中的应用**  
- **Pareto 分布** 常用于描述 **高收入群体的分布**。  
  - **公式：**  
    $$
    P(X > x) = \left(\frac{x_m}{x}\right)^\lambda \quad (x \geq x_m)
    $$
    - \(x_m\)：最小收入阈值。  
  
 - \(\lambda\)：**形状参数**，控制收入不平等程度。

- **含义：**
  - 当 \(\lambda = 2\) 时，收入超过 $100,000 的人的平均收入为 $200,000。
  - **较小的 \(\lambda\)** 表示不平等更严重。

---

## **5. 篮球投篮数据的可视化分析：Steph Curry 案例**  

### **5.1 投篮模式的分析**
- **数据来源：** Steph Curry 的比赛数据。  
  - **2D 直方图：** 展示了 **篮下和三分线附近** 的投篮集中区域。
  - **3D 热力图：** 通过将 **距离和位置结合**，展示投篮的热点。

---

## **6. 总结与学习要点**

1. **KDE 的重要性：** 提供平滑的分布估计，有效处理小样本问题。
2. **PDF 和 CDF 的比较：** PDF 更适合分析密度，CDF 更适合做概率比较。
3. **Pareto 分布在经济学中的应用：** 帮助量化高收入不平等问题。

---

## **7. 后续学习建议**
1. 在 R 中使用 **`density()`** 函数实践 KDE。
2. 阅读 **Piketty 和 Saez** 的研究，了解收入不平等趋势。
3. 学习 **因果推断**，分析遗传和环境对数据的影响。